# This file was generated by https://github.com/kamilchm/go2nix v1.2.1
{ stdenv, buildGoPackage, fetchgit, fetchhg, fetchbzr, fetchsvn,
  procps, iproute, which, findutils
}:

buildGoPackage rec {
  name = "batexpe-v${version}";
  version = "0.2.0";
  rev = "b9a38fd8f37304894d5d3c88c3ee68569d3883ba";

  goPackagePath = "gitlab.inria.fr/batsim/batexpe";

  src = fetchgit {
    inherit rev;
    url = "https://gitlab.inria.fr/batsim/batexpe.git";
    sha256 = "1iam499l38nwckdk0znh8xxn16k29fpcr6pgz4vza43rqa5mrh22";
  };

  runtimeDependencies = [procps iproute];
  buildInputs = runtimeDependencies ++ [which findutils];

  patchPhase = ''
    # Batexpe binaries have runtime dependencies to multiple programs.
    # This patch changes the code so it calls the realpath of the needed
    # program, so that nix can determine this is a runtime dependency.
    # For example, batexpe will run "/nix/store/.../bin/ss" instead of "ss".

    ########
    # bash #
    ########
    find . -type f -maxdepth 1 -name '*.go' \
      -exec sed -i -e "sW\"bash\"W\"$(which bash)\"Wg" {} \;

    #######################
    # "Real" dependencies #
    #######################
    # ps
    find . -type f -maxdepth 1 -name '*.go' \
      -exec sed -i -e "sW\"ps\"W\"$(which ps)\"Wg" {} \;

    # ss
    find . -type f -maxdepth 1 -name '*.go' \
      -exec sed -i -e "sW\"ss\"W\"$(which ss)\"Wg" {} \;

    ####################################
    # File preview and partial reading #
    ####################################
    # wc
    find . -type f -maxdepth 1 -name '*.go' \
      -exec sed -i -e "sW\"wc\"W\"$(which wc)\"Wg" {} \;

    # head
    find . -type f -maxdepth 1 -name '*.go' \
      -exec sed -i -e "sW\"head\"W\"$(which head)\"Wg" {} \;

    # tail
    find . -type f -maxdepth 1 -name '*.go' \
      -exec sed -i -e "sW\"tail\"W\"$(which tail)\"Wg" {} \;
  '';

  goDeps = ./deps.nix;

  # TODO: add metadata https://nixos.org/nixpkgs/manual/#sec-standard-meta-attributes
  meta = {
  };
}
